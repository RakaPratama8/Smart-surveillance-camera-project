import streamlit as st
from model.estimator import CrowdDensityEstimation
from utils.camera_utils import initialize_camera, process_video_frame


def main():
    st.title("Crowd Anomaly Detection Dashboard")
    st.sidebar.header("Settings")

    # Sidebar options
    model_path = st.sidebar.text_input("Model Path", "./model/yolo11n.pt")
    conf_threshold = st.sidebar.slider("Confidence Threshold", 0.1, 1.0, 0.3)

    # Initialize the estimator
    estimator = CrowdDensityEstimation(model_path=model_path, conf_threshold=conf_threshold)

    # Video stream
    st.header("Live Video Stream")
    cap = initialize_camera()

    # Stream video
    frame_placeholder = st.empty()
    while True:
        ret, frame = cap.read()
        if not ret:
            st.error("Failed to capture video.")
            break

        processed_frame, density_info, _ = estimator.process_frame(frame)
        frame_placeholder.image(processed_frame, channels="BGR", use_column_width=True)

        # Display density info
        st.sidebar.write("Density Info:")
        st.sidebar.write(f"Density Level: {density_info[1]}")
        st.sidebar.write(f"Person Count: {density_info[2]}")
        st.sidebar.write(f"Density Value: {density_info[0]:.2f}")

        if st.sidebar.button("Stop"):
            break

    cap.release()

if __name__ == "__main__":
    main()